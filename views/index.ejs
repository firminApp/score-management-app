<!DOCTYPE html>
<html>

<head>
  <title>Score management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css" type="css" />
  <style>
    .stranparent_bg {
      background: rgba(76, 175, 80, 0.3);
      border-radius: 8%;
        /* Green background with 30% opacity */

    }
.dark_green_bg{
  background: rgba(82, 95, 83, 0.562);

}
    .circle {
      border: 2px solid red;
      background-color: #FFFFFF;
      height: 100px;
      border-radius: 50%;
      width: 100px;
    }
  </style>
</head>

<body class=" row card card-well  " style="background-image: url(assets/images/scor_back.jpg);">
<div class=" container mt-4">
  <h1 class="display-4  dark_green_bg  text-white text-center m-3 h1">SCORE MANAGEMENT</h1>
  <div class=" row container">
    <div class="card col-2 m-1 stranparent_bg text-white">
      <h1 class="text-center">Teams</h1>
      <table class=" table table-light stranparent_bg text-white">
        <% teams.forEach(function(team){ %>
          <tr>
            <td>
              <%= team.name %>
            </td>
          </tr>
          <% }); %>
      </table>
    </div>

    <div class="card col m-2 stranparent_bg" id="lead_div">
      <h2 class="text-white text-center">Leaderboard</h2>
      <table class=" table table-dark stranparent_bg text-white table-bordered" id="lead_table">
        <thead>
          <th>NÂ°</th>
          <th>Team</th>
          <th>Games</th>
          <th>Win</th>
          <th>Nulls</th>
          <th>Lost</th>
          <th>Diff</th>
          <th>Pts</th>
        </thead>
        <tbody>
          <% leaderbord.forEach(function(mark,i){ %>
            <tr>
              <td > <span style="font-size: large;" class="badge badge-white"><%= ++i %></span></td>
              <td><%= mark.name %></td>
              <td><%= mark.played_match %></td>
              <td><span class="badge badge-success badge-sm"><%= mark.win %></span></td>
              <td><span class="badge badge-warning badge-sm"><%= mark.nulls %></span></td>
              <td><span class="badge badge-danger badge-sm"><%= mark.lost %></span></td>
              <td>
                <% if(mark.goals_diff>0) { %>
                  <span class="badge badge-success badge-sm">+<%= mark.goals_diff %></span>
                <% } else if(mark.goals_diff<0){ %>
                  <span class="badge badge-danger badge-sm"><%= mark.goals_diff %></span>
                  <% } else {%>
                    <span class="badge badge-default badge-sm"><%= mark.goals_diff %></span>
                  <% }  %>
              </td>

              <td><span class="badge badge-primary badge-sm"><%= mark.marks %></span></td>
            </tr>
            <% }); %>
        </tbody>

      </table>
      
    </div>

    <div class="card col-4 m-1 stranparent_bg text-white " style="max-height: 600px;">
      <h2 class="text-white text-center">Games</h2>
      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#add_score_modal" id="add_score_btn">New score</button>
     <div class="table-responsive" >
      <table class=" table table-light stranparent_bg text-white">
        <% games.forEach(function(game){ %>
          <tr>
            <td>
              <%= game.team_1 && game.team_2?  game.team_1.name+ " "+ game.score_team_1+ " -"+ game.score_team_2+" "+ game.team_2.name:""%>  -<span class="text-sm text-info" style="font-size: 0.75em;"><%=moment(game.created_at).calendar() %></span>
            </td>
          </tr>
          <% }); %>
      </table>
    </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-sm text-center text-white dark_green_bg">
        By firminapp@gmail.com 
      </div>
    </div>
  </div>
  
  <div class="modal fade add_game_modal " id="add_score_modal" tabindex="-1" role="dialog" aria-labelledby="smallModalHead" aria-hidden="true">
    <div class="modal-dialog ">
      <div class="modal-content ">
        <div class="modal-header ">
          <h5 class="modal-title">New Score</h5>
        </div>
        <div class="form  badge-default " id="add_score_form">
          <form action="/games/store" method="POST" enctype="multipart/form-data">
            <div class="form-group m-2">
            <div class="row col-12 m-2">
              <div class="input-group mb-3 col-6">
                <div class="input-group-prepend ">
                  <select class="input-group-select" name="team_1_id" id="" required>
                    <option>Select team 1...</option>
                    <% teams.forEach(function(team){ %>
                      <option value="<%=team._id %>">
                         <%= team.name %>
                     </option>
                     <% }); %>
                  </select>
                </div>
                <input type="text" name="score_team_1"  placeholder="0" required class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
              </div>
              <div class="input-group mb-3 col-6">
                <input type="text"  name="score_team_2" placeholder="0" required class="form-control"  aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                <div class="input-group-prepend">
                  <select class="input-group-select" name="team_2_id" id="" required>
                    <option>Select team 2...</option>
                    <% teams.forEach(function(team){ %>
                       <option value="<%=team._id %>">
                          <%= team.name %>
                      </option>
                      <% }); %>
                  </select>
                </div>
              </div>

            </div>
            <div class="modal-footer row col-12">
              <button class="btn btn-default btn-sm"   data-dismiss="modal">Cancel</button>
              <button class="btn btn-primary btn-sm" type="submit">Save</button>
            </div>
          </form>
       </div>
      </div>
    </div>
  </div>

</div>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</body>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>

    var socket = io("ws://localhost:3300");
    socket.on("new_score", function(data){
        updateLeaderBoard();
      })
    function testSocket(){
      socket.emit("new_score","testing");
      updateLeaderBoard();
    }
    function updateLeaderBoard(){
      $.ajax('/update_leaderboard', {
        type: 'GET',  // http method
        success: function (data, status, xhr) {
            build_LeaderBoard(data.data)
        },
        error: function (jqXhr, textStatus, errorMessage) {
        }

    });
    }

function build_LeaderBoard(marks){
  let content=``;
  let i=0;
  for(let mark of marks){
    let goal_diff_text=``;
    if(mark.goals_diff>0){
      goal_diff_text=`<span class="badge badge-success badge-sm">+${mark.goals_diff}</span>`

    }else if(mark.goals_diff<0){
      goal_diff_text=`<span class="badge badge-danger badge-sm">${mark.goals_diff} </span>`

    }else{
      goal_diff_text=`<span class="badge badge-default badge-sm">${mark.goals_diff}</span>`
    }
    content+=`
            <tr>
              <td > <span style="font-size: large;" class="badge badge-white">${ ++i}</span></td>
              <td>${ mark.name}</td>
              <td>${ mark.played_match}</td>
              <td><span class="badge badge-success badge-sm">${ mark.win}</span></td>
              <td><span class="badge badge-warning badge-sm">${ mark.nulls}</span></td>
              <td><span class="badge badge-danger badge-sm">${ mark.lost}</span></td>
              <td>
               ${goal_diff_text}
              </td>
              <td><span class="badge badge-primary badge-sm">${mark.marks}</span></td>
            </tr>
      `
  }
  $("#lead_div").find("tbody").html(content);
}

</script>

</html>